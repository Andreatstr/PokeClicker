# Apache configuration for Pok√©Clicker Project 2
# Deploy at: http://it2810-26.idi.ntnu.no/project2/

<VirtualHost *:80>
    ServerName it2810-26.idi.ntnu.no
    DocumentRoot /var/www/html

    # Serve frontend from /project2/
    Alias /project2 /var/www/html/project2

    <Directory /var/www/html/project2>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Enable CORS for frontend to call backend
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Authorization"

        # SPA routing - serve index.html for all routes
        # This ensures refresh on /pokedex or other routes works correctly
        RewriteEngine On
        RewriteBase /project2/

        # Don't rewrite if file/directory exists
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d

        # Serve index.html for all other routes
        RewriteRule . /project2/index.html [L]
    </Directory>

    # Proxy GraphQL backend requests to localhost:3001
    # Frontend will call /project2/graphql which proxies to backend
    ProxyPreserveHost On
    ProxyPass /project2/graphql http://localhost:3001/
    ProxyPassReverse /project2/graphql http://localhost:3001/

    # Handle CORS preflight requests for GraphQL endpoint
    <Location /project2/graphql>
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Authorization"

        # Handle OPTIONS requests for CORS preflight
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </Location>

    # Enable required Apache modules:
    # a2enmod proxy proxy_http headers rewrite

    ErrorLog ${APACHE_LOG_DIR}/project2-error.log
    CustomLog ${APACHE_LOG_DIR}/project2-access.log combined
</VirtualHost>
